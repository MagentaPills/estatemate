<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Property – EstateMate</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .slide { display: none; }
    .slide.active { display: block; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
  <!-- Header -->
  <header class="bg-white shadow-md">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
      <a href="browse.html" class="text-2xl font-bold text-indigo-600">EstateMate</a>
      <nav class="flex items-center gap-6">
        <a href="browse.html" class="text-gray-600 hover:text-indigo-600">Browse</a>
        <a href="index.html"  class="text-gray-600 hover:text-indigo-600">Home</a>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="container mx-auto px-6 py-10 grid grid-cols-1 lg:grid-cols-3 gap-10">
    <!-- Gallery / Map slider -->
    <section class="lg:col-span-2">
      <div class="relative rounded-2xl overflow-hidden shadow bg-white">
        <div id="slider" class="relative">
          <!-- slides injected here -->
        </div>

        <button id="prevBtn" aria-label="Previous"
          class="absolute left-3 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white rounded-full px-3 py-2 shadow">
          ‹
        </button>
        <button id="nextBtn" aria-label="Next"
          class="absolute right-3 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white rounded-full px-3 py-2 shadow">
          ›
        </button>
      </div>

      <!-- thumbnails (optional / simple dots) -->
      <div id="dots" class="flex gap-2 mt-4"></div>
    </section>

    <!-- Details / Purchase -->
    <aside class="space-y-6">
      <div class="bg-white rounded-2xl shadow p-6">
        <h1 id="title" class="text-2xl font-extrabold mb-1">Property</h1>
        <p id="address" class="text-gray-500 text-sm mb-4">—</p>

        <div class="flex items-center justify-between">
          <div>
            <p id="price" class="text-2xl font-bold text-indigo-600">AED —</p>
            <p id="specs" class="text-gray-500 text-sm mt-1"></p>
          </div>
          <button id="buyBtn"
                  class="bg-indigo-600 text-white px-5 py-3 rounded-xl font-semibold hover:bg-indigo-700">
            Buy now
          </button>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow p-6">
        <h2 class="font-bold mb-2">Agent</h2>
        <p class="text-sm text-gray-600" id="agent">—</p>
      </div>

      <div class="bg-white rounded-2xl shadow p-6">
        <h2 class="font-bold mb-2">Amenities</h2>
        <p class="text-sm text-gray-600" id="amenities">—</p>
      </div>
    </aside>
  </main>

  <!-- Fake checkout modal -->
  <div id="checkout" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4">
    <div class="bg-white max-w-md w-full rounded-2xl p-6 shadow-xl">
      <h3 class="text-xl font-bold mb-4">Complete purchase</h3>
      <form id="checkoutForm" class="space-y-3">
        <input class="w-full border rounded-lg px-3 py-2" placeholder="Full name" required />
        <input class="w-full border rounded-lg px-3 py-2" placeholder="Email" type="email" required />
        <input class="w-full border rounded-lg px-3 py-2" placeholder="Card number" required />
        <div class="flex gap-3">
          <input class="flex-1 border rounded-lg px-3 py-2" placeholder="MM/YY" required />
          <input class="flex-1 border rounded-lg px-3 py-2" placeholder="CVC" required />
        </div>
        <div class="flex items-center justify-end gap-2 pt-2">
          <button type="button" id="cancelCheckout" class="px-4 py-2 rounded-lg border">Cancel</button>
          <button class="px-4 py-2 rounded-lg bg-indigo-600 text-white">Pay</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    const API_BASE = "http://localhost:8080";

    // --- helpers
    const $ = (sel) => document.querySelector(sel);
    const fmtAED = (n) => (n == null || isNaN(n)) ? 'Price on request' : 'AED ' + Number(n).toLocaleString('en-AE');

    const params = new URLSearchParams(location.search);
    const id  = params.get('id');
    let lat   = params.get('lat')  ? Number(params.get('lat'))  : undefined;
    let lng   = params.get('lng')  ? Number(params.get('lng'))  : undefined;

    // UI refs
    const slider   = $("#slider");
    const dotsWrap = $("#dots");
    const titleEl  = $("#title");
    const address  = $("#address");
    const priceEl  = $("#price");
    const specsEl  = $("#specs");
    const agentEl  = $("#agent");
    const amEl     = $("#amenities");
    const buyBtn   = $("#buyBtn");
    const checkout = $("#checkout");
    const cancelCheckout = $("#cancelCheckout");
    const checkoutForm   = $("#checkoutForm");

    // slider state
    let slides = [];
    let current = 0;

    function setSlide(i) {
      if (!slides.length) return;
      current = (i + slides.length) % slides.length;
      [...slider.children].forEach((child, idx) => {
        child.classList.toggle("active", idx === current);
      });
      [...dotsWrap.children].forEach((dot, idx) => {
        dot.classList.toggle("bg-indigo-600", idx === current);
        dot.classList.toggle("bg-gray-300", idx !== current);
      });
    }

    $("#prevBtn").addEventListener("click", () => setSlide(current - 1));
    $("#nextBtn").addEventListener("click", () => setSlide(current + 1));

    function addSlide(node) {
      node.classList.add("slide");
      slider.appendChild(node);
    }

    function addDot(idx) {
      const b = document.createElement("button");
      b.className = "w-2.5 h-2.5 rounded-full bg-gray-300";
      b.addEventListener("click", () => setSlide(idx));
      dotsWrap.appendChild(b);
    }

    function mapIframe(lat, lng) {
      const src = `https://maps.google.com/maps?q=${lat},${lng}&z=15&output=embed`;
      const wrap = document.createElement("div");
      wrap.innerHTML = `
        <iframe
          class="w-full h-[360px] md:h-[480px] block"
          loading="lazy"
          referrerpolicy="no-referrer-when-downgrade"
          src="${src}">
        </iframe>
      `;
      return wrap.firstElementChild;
    }

    function imageSlide(url) {
      const img = document.createElement("img");
      img.src = url;
      img.alt = "Property photo";
      img.className = "w-full h-[360px] md:h-[480px] object-cover block";
      return img;
    }

    function buildSlider(listing) {
      slider.innerHTML = "";
      dotsWrap.innerHTML = "";
      slides = [];

      // images from data if present
      const imgs = Array.isArray(listing.images) ? listing.images.filter(Boolean) : [];
      imgs.slice(0, 5).forEach((u) => {
        addSlide(imageSlide(u));
        slides.push(u);
      });

      // map slide (uses lat/lng either from data or URL params)
      const la = Number(listing.latitude)  || lat;
      const lo = Number(listing.longitude) || lng;

      if (Number.isFinite(la) && Number.isFinite(lo)) {
        const iframe = mapIframe(la, lo);
        const mapWrap = document.createElement("div");
        mapWrap.appendChild(iframe);
        addSlide(mapWrap);
        slides.push("map");
      }

      // fallback placeholder when no images and no map
      if (!slides.length) {
        const ph = document.createElement("div");
        ph.className = "w-full h-[360px] md:h-[480px] bg-gray-200 flex items-center justify-center text-gray-400";
        ph.textContent = "No media";
        addSlide(ph);
        slides.push("ph");
      }

      // dots
      slides.forEach((_, i) => addDot(i));
      setSlide(0);
    }

    function fillDetails(listing) {
      titleEl.textContent = listing.property_type || "Property";
      priceEl.textContent = fmtAED(listing.price);
      const addr = [listing.community || listing.city, "Dubai"].filter(Boolean).join(", ");
      address.textContent = addr || "—";

      const specs = [
        listing.bedrooms  ? `${listing.bedrooms} bd` : null,
        listing.bathrooms ? `${listing.bathrooms} ba` : null,
        listing.size_sqft ? `${Number(listing.size_sqft).toLocaleString()} sqft` : null,
      ].filter(Boolean).join(" · ");
      specsEl.textContent = specs;

      agentEl.textContent = [listing.agent_name, listing.agency_name].filter(Boolean).join(" – ") || "—";
      amEl.textContent    = listing.amenities || "—";
    }

    async function load() {
      let listing = null;

      // Try API by id (if backend supports it)
      if (id) {
        try {
          const res = await fetch(`${API_BASE}/api/listings?id=${encodeURIComponent(id)}&limit=1`);
          if (res.ok) {
            const data = await res.json();
            if (data && Array.isArray(data.listings) && data.listings.length) {
              listing = data.listings[0];
            }
          }
        } catch (_) {}
      }

      // If not found, try to pull one that’s close to given lat/lng as a very loose fallback
      if (!listing && lat && lng) {
        try {
          const res = await fetch(`${API_BASE}/api/listings?limit=50`);
          if (res.ok) {
            const data = await res.json();
            if (data && Array.isArray(data.listings) && data.listings.length) {
              // crude nearest by simple distance
              data.listings.forEach((x) => {
                x.__d = (x.latitude && x.longitude)
                  ? Math.hypot(Number(x.latitude) - lat, Number(x.longitude) - lng)
                  : Number.POSITIVE_INFINITY;
              });
              data.listings.sort((a,b) => a.__d - b.__d);
              listing = data.listings[0];
            }
          }
        } catch (_) {}
      }

      // Still nothing – create a stub from URL
      if (!listing) {
        listing = { property_type: "Property", price: null, bedrooms: null, bathrooms: null, size_sqft: null,
                    city: "Dubai", community: "", latitude: lat, longitude: lng, images: [] };
      }

      // keep coords for map slide
      if (!lat) lat = Number(listing.latitude);
      if (!lng) lng = Number(listing.longitude);

      buildSlider(listing);
      fillDetails(listing);
    }

    // checkout UI
    buyBtn.addEventListener("click", () => checkout.classList.remove("hidden"));
    cancelCheckout.addEventListener("click", () => checkout.classList.add("hidden"));
    checkoutForm.addEventListener("submit", (e) => {
      e.preventDefault();
      checkout.classList.add("hidden");
      alert("Thanks! We’ll email you a purchase agreement.");
    });

    load();
  </script>
</body>
</html>
