<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Dashboard ‚Äì EstateMate</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body{
      background:#f9fafb;
      background-image:
        radial-gradient(circle at 20% 20%, rgba(99,102,241,0.08) 0%, rgba(255,255,255,0) 70%),
        radial-gradient(circle at 80% 30%, rgba(168,85,247,0.05) 0%, rgba(255,255,255,0) 70%);
      background-repeat:no-repeat;
    }
    .card{
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.6);
      backdrop-filter:saturate(140%) blur(6px);
    }
    .chart-wrap{ height:18rem; }   /* prevents infinite growth */
    .table-wrap{ max-height:18rem; overflow:auto; }
    .scrolly{ max-height:22rem; overflow:auto; }
  </style>
</head>
<body class="min-h-screen text-gray-900 flex flex-col">

  <!-- HEADER -->
  <header class="bg-white border-b border-gray-100 relative overflow-hidden">
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_20%_20%,rgba(99,102,241,0.07),transparent_60%)] pointer-events-none"></div>
    <div class="relative z-10 max-w-7xl mx-auto flex items-center justify-between px-4 py-3 sm:px-6">
      <a href="index.html" class="flex items-center gap-2 text-xl font-semibold text-indigo-600">
        <span>EstateMate</span>
        <span class="text-[11px] font-medium text-indigo-600/80 bg-indigo-50 px-2 py-1 rounded-lg border border-indigo-200/60">AI Preview</span>
      </a>
      <!-- Dashboard before Browse -->
      <nav class="flex items-center gap-6 text-[15px] font-medium text-gray-700">
        <a href="dashboard.html" class="text-indigo-600 font-semibold">Dashboard</a>
        <a href="browse.html"   class="hover:text-indigo-600 transition">Browse</a>
        <a href="map.html"      class="hover:text-indigo-600 transition">Map</a>
        <a href="about.html"    class="hover:text-indigo-600 transition">About</a>
        <a href="contact.html"  class="hover:text-indigo-600 transition">Contact</a>
        <a id="signInBtn" href="auth.html"
           class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-full hover:bg-indigo-700 transition whitespace-nowrap hidden">Sign in</a>
        <button id="signOutBtn" type="button"
           class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-full hover:bg-indigo-700 transition whitespace-nowrap hidden">Sign out</button>
      </nav>
    </div>
  </header>

  <!-- MAIN -->
  <main class="flex-1 w-full max-w-7xl mx-auto px-4 sm:px-6 py-8">
    <!-- Title -->
    <section class="text-center max-w-3xl mx-auto">
      <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight text-gray-900">Listings Dashboard</h1>
      <p class="mt-3 text-gray-600">KPIs, distributions, communities, top lists ‚Äî plus AI picks generated from your saved preferences.</p>
    </section>

    <!-- Filters -->
    <section class="mt-6 bg-white/80 backdrop-blur border border-white/40 shadow rounded-2xl p-4">
      <div class="flex flex-col sm:flex-row items-center gap-3">
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-700">City:</label>
          <input id="cityInput" class="rounded-lg border-gray-300 focus:ring-indigo-400 focus:border-indigo-400 text-sm px-3 py-2" placeholder="(optional) e.g., Dubai"/>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-700">Min price:</label>
          <input id="minPriceInput" type="number" min="0" step="1000" class="w-32 rounded-lg border-gray-300 focus:ring-indigo-400 focus:border-indigo-400 text-sm px-3 py-2" placeholder="500000"/>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-700">Max price:</label>
          <input id="maxPriceInput" type="number" min="0" step="1000" class="w-32 rounded-lg border-gray-300 focus:ring-indigo-400 focus:border-indigo-400 text-sm px-3 py-2" placeholder="3000000"/>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-700">Limit:</label>
          <input id="limitInput" type="number" min="50" step="50" value="1000" class="w-24 rounded-lg border-gray-300 focus:ring-indigo-400 focus:border-indigo-400 text-sm px-3 py-2"/>
        </div>
        <button id="applyBtn" class="ml-auto sm:ml-0 inline-flex items-center justify-center rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 text-sm shadow">Apply</button>
        <span id="countText" class="text-xs text-gray-500">Loading‚Ä¶</span>
      </div>
    </section>

    <!-- KPI Cards -->
    <section class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
      <div class="card rounded-2xl shadow p-4">
        <p class="text-xs uppercase tracking-wide text-indigo-600 font-semibold">Total listings</p>
        <p id="kpiCount" class="text-2xl font-extrabold mt-1">‚Äî</p>
        <p class="text-xs text-gray-500">After filters</p>
      </div>
      <div class="card rounded-2xl shadow p-4">
        <p class="text-xs uppercase tracking-wide text-indigo-600 font-semibold">Avg. price (AED)</p>
        <p id="kpiAvgPrice" class="text-2xl font-extrabold mt-1">‚Äî</p>
        <p class="text-xs text-gray-500">Mean</p>
      </div>
      <div class="card rounded-2xl shadow p-4">
        <p class="text-xs uppercase tracking-wide text-indigo-600 font-semibold">Median price (AED)</p>
        <p id="kpiMedPrice" class="text-2xl font-extrabold mt-1">‚Äî</p>
        <p class="text-xs text-gray-500">Robust center</p>
      </div>
      <div class="card rounded-2xl shadow p-4">
        <p class="text-xs uppercase tracking-wide text-indigo-600 font-semibold">Median price / m¬≤ (AED)</p>
        <p id="kpiPsm" class="text-2xl font-extrabold mt-1">‚Äî</p>
        <p class="text-xs text-gray-500">Size-normalized</p>
      </div>
    </section>

    <!-- Charts -->
    <section class="mt-6 grid gap-6 lg:grid-cols-2">
      <div class="card rounded-2xl shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-base font-semibold">Price distribution (AED)</h3>
          <span class="text-xs text-gray-500">Histogram</span>
        </div>
        <div class="chart-wrap"><canvas id="histPrice"></canvas></div>
      </div>

      <div class="card rounded-2xl shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-base font-semibold">Size distribution (m¬≤)</h3>
          <span class="text-xs text-gray-500">Histogram</span>
        </div>
        <div class="chart-wrap"><canvas id="histSize"></canvas></div>
      </div>

      <div class="card rounded-2xl shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-base font-semibold">Property type mix</h3>
        </div>
        <div class="chart-wrap"><canvas id="typeMix"></canvas></div>
      </div>

      <div class="card rounded-2xl shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-base font-semibold">Top communities by median price</h3>
          <span class="text-xs text-gray-500">Bar (Top 10)</span>
        </div>
        <div class="chart-wrap"><canvas id="commTop"></canvas></div>
      </div>

      <div class="card rounded-2xl shadow p-4 lg:col-span-2">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-base font-semibold">Price vs Size (m¬≤)</h3>
        </div>
        <div class="chart-wrap"><canvas id="scatter"></canvas></div>
      </div>
    </section>

    <!-- Recommendations (auto) -->
    <section class="mt-8 grid gap-6 lg:grid-cols-2">
      <div class="card rounded-2xl shadow p-5">
        <h2 class="text-lg font-semibold text-gray-900 mb-2">Recommended for you</h2>
        <p class="text-sm text-gray-600">Based on your saved preferences (update them on the home page).</p>
        <div class="mt-3 text-xs text-gray-500 space-y-1" id="recPrefsEcho"></div>
      </div>

      <div class="card rounded-2xl shadow p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-gray-900">Top 5</h2>
          <span id="recBadge" class="text-xs text-gray-500">‚Äî</span>
        </div>
        <div id="recList" class="scrolly divide-y divide-gray-100 mt-3"></div>
        <p id="recError" class="hidden mt-3 text-center text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg px-3 py-2"></p>
      </div>
    </section>

    <!-- Tables -->
    <section class="mt-8 grid gap-6 lg:grid-cols-2">
      <div class="card rounded-2xl shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-base font-semibold">Most expensive listings</h3>
          <span class="text-xs text-gray-500">Top 10</span>
        </div>
        <div class="table-wrap">
          <table class="w-full text-sm">
            <thead class="text-gray-500">
              <tr>
                <th class="text-left py-2">Title</th>
                <th class="text-left py-2">Community</th>
                <th class="text-right py-2">Price (AED)</th>
              </tr>
            </thead>
            <tbody id="tblTopPrice" class="divide-y"></tbody>
          </table>
        </div>
      </div>

      <div class="card rounded-2xl shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-base font-semibold">Best price / m¬≤</h3>
          <span class="text-xs text-gray-500">Top 10 (lowest)</span>
        </div>
        <div class="table-wrap">
          <table class="w-full text-sm">
            <thead class="text-gray-500">
              <tr>
                <th class="text-left py-2">Title</th>
                <th class="text-left py-2">Community</th>
                <th class="text-right py-2">AED / m¬≤</th>
              </tr>
            </thead>
            <tbody id="tblBestPsm" class="divide-y"></tbody>
          </table>
        </div>
      </div>
    </section>

    <p id="errorBox" class="hidden mt-6 text-center text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg px-4 py-3"></p>
  </main>

  <!-- Logic -->
  <script type="module">
    /******** Firebase auth (same project) ********/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCZpPsSgm9bnBeed7nRuHJOBc7MGhH0jpQ",
      authDomain: "estatemate-d54e1.firebaseapp.com",
      projectId: "estatemate-d54e1",
      storageBucket: "estatemate-d54e1.firebasestorage.app",
      messagingSenderId: "745236119215",
      appId: "1:745236119215:web:7170303f7be0010ad79e5a",
      measurementId: "G-RXWF5891QM"
    };

    const app = window._emApp || initializeApp(firebaseConfig);
    window._emApp = app;
    const auth = getAuth(app);

    const signInBtn  = document.getElementById("signInBtn");
    const signOutBtn = document.getElementById("signOutBtn");
    const show = el => el && el.classList.remove("hidden");
    const hide = el => el && el.classList.add("hidden");

    onAuthStateChanged(auth, (user)=>{
      user ? (hide(signInBtn), show(signOutBtn)) : (show(signInBtn), hide(signOutBtn));
    });
    signOutBtn?.addEventListener("click", ()=> signOut(auth).catch(()=>{}));

    /******** Helpers ********/
    const fmt = n => (n==null || isNaN(n)) ? "‚Äî" : n.toLocaleString("en-US");
    const fmtAED = n => (n==null || isNaN(n)) ? "Price on request" : "AED " + Number(n).toLocaleString("en-AE");
    const toM2 = sqft => sqft!=null ? sqft * 0.092903 : null;

    function median(arr){
      const a = arr.filter(x=>x!=null && !isNaN(x)).slice().sort((x,y)=>x-y);
      if (!a.length) return null;
      const m = Math.floor(a.length/2);
      return a.length%2? a[m] : (a[m-1]+a[m])/2;
    }
    function bin(values, binCount=20){
      const v = values.filter(x=>x!=null && !isNaN(x));
      if (!v.length) return {labels:[],counts:[]};
      const min = Math.min(...v), max = Math.max(...v);
      if (min===max) return {labels:[fmt(min)], counts:[v.length]};
      const step = (max-min)/binCount;
      const counts = new Array(binCount).fill(0);
      for (const x of v){
        let idx = Math.floor((x-min)/step);
        if (idx>=binCount) idx=binCount-1;
        counts[idx]++;
      }
      const labels = counts.map((_,i)=>{
        const a = Math.round(min + i*step);
        const b = Math.round(min + (i+1)*step);
        return `${a.toLocaleString()}‚Äì${b.toLocaleString()}`;
      });
      return {labels,counts};
    }

    const ctxs = {
      histPrice: document.getElementById("histPrice"),
      histSize:  document.getElementById("histSize"),
      typeMix:   document.getElementById("typeMix"),
      commTop:   document.getElementById("commTop"),
      scatter:   document.getElementById("scatter"),
    };
    const charts = {};
    function upsertChart(key, type, data, options){
      if (charts[key]) {
        charts[key].data = data;
        charts[key].options = options || {};
        charts[key].update();
        return;
      }
      charts[key] = new Chart(ctxs[key], { type, data, options });
    }

    // detail nav
    function openListing(row){
      try{ sessionStorage.setItem("selectedListing", JSON.stringify(row)); }catch(e){}
      window.location.href = "listing.html";
    }
    function linkCell(label, row, idx, scope){
      return `<a href="listing.html" data-${scope}-idx="${idx}" class="text-indigo-600 hover:underline">${label}</a>`;
    }
    function fillTable(el, rows, scope, cols){
      el.innerHTML = rows.map((r, i)=>`
        <tr class="hover:bg-gray-50">
          ${cols.map(c=>`<td class="py-2 ${c.right?'text-right':''}">${c.render(r,i)}</td>`).join('')}
        </tr>`).join('');
      el.querySelectorAll(`a[data-${scope}-idx]`).forEach(a=>{
        const i = Number(a.dataset[`${scope}Idx`]);
        a.addEventListener('click', (ev)=>{ ev.preventDefault(); openListing(rows[i]); });
      });
    }

    /******** API ********/
    const listingCache = new Map();
    async function fetchListings(){
      const params = new URLSearchParams();
      const city = cityInput.value.trim();
      const minP = minPriceInput.value.trim();
      const maxP = maxPriceInput.value.trim();
      const limit= Number(limitInput.value || 1000);
      if (city)  params.set('city', city);
      if (minP)  params.set('minPrice', minP);
      if (maxP)  params.set('maxPrice', maxP);
      params.set('limit', isNaN(limit)?1000:limit);

      const res = await fetch(`/api/listings?${params.toString()}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const j = await res.json();
      if (!j.ok) throw new Error(j.error || 'Unknown error');
      for (const r of (j.listings||[])) if (r.listing_id) listingCache.set(r.listing_id, r);
      return j.listings || [];
    }
    async function fetchListingById(id){
      if (listingCache.has(id)) return listingCache.get(id);
      const res = await fetch(`/api/listings?id=${encodeURIComponent(id)}`);
      const j = await res.json();
      const row = (j && j.listings && j.listings[0]) || null;
      if (row && row.listing_id) listingCache.set(row.listing_id, row);
      return row;
    }

    /******** Dashboard refresh ********/
    const cityInput    = document.getElementById("cityInput");
    const minPriceInput= document.getElementById("minPriceInput");
    const maxPriceInput= document.getElementById("maxPriceInput");
    const limitInput   = document.getElementById("limitInput");
    const applyBtn     = document.getElementById("applyBtn");
    const countText    = document.getElementById("countText");
    const errorBox     = document.getElementById("errorBox");

    const kpiCount     = document.getElementById("kpiCount");
    const kpiAvgPrice  = document.getElementById("kpiAvgPrice");
    const kpiMedPrice  = document.getElementById("kpiMedPrice");
    const kpiPsm       = document.getElementById("kpiPsm");

    const tblTopPrice  = document.getElementById("tblTopPrice");
    const tblBestPsm   = document.getElementById("tblBestPsm");

    async function refresh(){
      errorBox.classList.add("hidden");
      countText.textContent = "Loading‚Ä¶";
      try{
        const listings = await fetchListings();
        countText.textContent = `${listings.length.toLocaleString()} listings`;
        kpiCount.textContent  = fmt(listings.length);

        const prices = listings.map(l=>l.price).filter(x=>x!=null);
        const sizesM2= listings.map(l=>toM2(l.size_sqft)).filter(x=>x!=null);
        const psmArr = listings.map(l=>{
          const m2 = toM2(l.size_sqft);
          return (l.price!=null && m2) ? (l.price / m2) : null;
        }).filter(x=>x!=null && isFinite(x));

        const avgPrice = prices.length ? prices.reduce((a,b)=>a+b,0)/prices.length : null;
        kpiAvgPrice.textContent = fmt(Math.round(avgPrice||0));
        kpiMedPrice.textContent = fmt(Math.round(median(prices)||0));
        kpiPsm.textContent      = fmt(Math.round(median(psmArr)||0));

        // charts
        const priceBins = bin(prices, 24);
        upsertChart("histPrice","bar",{
          labels: priceBins.labels,
          datasets:[{ label:"Count", data:priceBins.counts }]
        },{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{display:false} },
          scales:{ y:{ beginAtZero:true }}
        });

        const sizeBins = bin(sizesM2, 24);
        upsertChart("histSize","bar",{
          labels: sizeBins.labels,
          datasets:[{ label:"Count", data:sizeBins.counts }]
        },{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{display:false} },
          scales:{ y:{ beginAtZero:true }}
        });

        const typeMap = new Map();
        for (const l of listings){
          const t = (l.property_type||'Unknown').toString();
          typeMap.set(t, (typeMap.get(t)||0)+1);
        }
        upsertChart("typeMix","doughnut",{
          labels:[...typeMap.keys()],
          datasets:[{ data:[...typeMap.values()] }]
        },{
          responsive:true,
          maintainAspectRatio:false
        });

        const communityPrices = new Map();
        for (const l of listings){
          if (l.community && l.price!=null){
            const k=l.community;
            (communityPrices.get(k)||communityPrices.set(k,[]).get(k)).push(l.price);
          }
        }
        const commMed = [...communityPrices.entries()]
          .map(([k,arr])=>({ community:k, med:median(arr)}))
          .filter(x=>x.med!=null)
          .sort((a,b)=>b.med-a.med)
          .slice(0,10);
        upsertChart("commTop","bar",{
          labels:commMed.map(x=>x.community),
          datasets:[{ label:"Median AED", data: commMed.map(x=>Math.round(x.med)) }]
        },{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{display:false} },
          scales:{ y:{ beginAtZero:true }}
        });

        const scatterPts = listings.map(l=>{
          const m2=toM2(l.size_sqft);
          return (l.price!=null && m2!=null)?{x:m2,y:l.price}:null;
        }).filter(Boolean);
        upsertChart("scatter","scatter",{
          datasets:[{ label:"Listing", data:scatterPts, pointRadius:2 }]
        },{
          responsive:true,
          maintainAspectRatio:false,
          scales:{
            x:{ title:{display:true,text:"m¬≤"}},
            y:{ title:{display:true,text:"AED"}}
          }
        });

        const topPrice = listings
          .filter(l=>l.price!=null)
          .sort((a,b)=>b.price-a.price)
          .slice(0,10);
        fillTable(tblTopPrice, topPrice, "tp", [
          { render: (r,i)=> linkCell((r.title||`${r.bedrooms?`${r.bedrooms}BR `:''}${r.property_type||'Property'}`), r, i, "tp") },
          { render: r=> (r.community || '‚Äî') },
          { render: r=> fmt(Math.round(r.price)), right:true },
        ]);

        const bestPsm = listings
          .map(l=>{
            const m2=toM2(l.size_sqft);
            return { ...l, psm: (l.price!=null && m2)? l.price/m2 : null };
          })
          .filter(l=>l.psm!=null && isFinite(l.psm))
          .sort((a,b)=>a.psm-b.psm)
          .slice(0,10);
        fillTable(tblBestPsm, bestPsm, "bp", [
          { render: (r,i)=> linkCell((r.title||`${r.bedrooms?`${r.bedrooms}BR `:''}${r.property_type||'Property'}`), r, i, "bp") },
          { render: r=> (r.community || '‚Äî') },
          { render: r=> fmt(Math.round(r.psm)), right:true },
        ]);

        // then fire recommendations
        try { await runRecommendationsFromSavedPrefs(); } catch {}
      } catch(err){
        errorBox.textContent = `Failed to load dashboard: ${err.message||err}`;
        errorBox.classList.remove("hidden");
        countText.textContent = "‚Äî";
      }
    }

    /******** Preferences (read from localStorage) ********/
    const recPrefsEcho = document.getElementById("recPrefsEcho");

    function loadSavedPrefs(uid){
      const keys = [];
      if (uid) keys.push(`em_quiz_prefs__${uid}`);
      keys.push('em_quiz_prefs','quiz_prefs','preferences','user_prefs');

      // also scan for any key that looks like "pref"
      for (let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i)||'';
        if (/pref/i.test(k) && !keys.includes(k)) keys.push(k);
      }

      for (const k of keys){
        try{
          const v = localStorage.getItem(k);
          if (!v) continue;
          const o = JSON.parse(v);
          if (o && typeof o==='object' && Object.keys(o).length) return o;
        }catch{}
      }
      return {};
    }

    // UPDATED: show all the quiz fields (areas, type, lifestyle, style, commute, budget mindset, notes, etc.)
    function echoPrefs(p){
      const rows = [];

      if (p.areas)          rows.push(`<div>üìç <b>Areas:</b> ${p.areas}</div>`);
      if (p.community)      rows.push(`<div>üìç <b>Community:</b> ${p.community}</div>`);
      if (p.property_type)  rows.push(`<div>üè∑Ô∏è <b>Type:</b> ${p.property_type}</div>`);
      if (p.bedrooms!=null && p.bedrooms!=="")
        rows.push(`<div>üõèÔ∏è <b>Bedrooms:</b> ${p.bedrooms}</div>`);
      if (p.bathrooms!=null && p.bathrooms!=="")
        rows.push(`<div>üõÅ <b>Bathrooms:</b> ${p.bathrooms}</div>`);

      if (Number.isFinite(p.budget_min) || Number.isFinite(p.budget_max)) {
        const min = Number.isFinite(p.budget_min) ? Number(p.budget_min).toLocaleString() : "‚Äî";
        const max = Number.isFinite(p.budget_max) ? Number(p.budget_max).toLocaleString() : "‚Äî";
        rows.push(`<div>üíµ <b>Budget range:</b> AED ${min} ‚Äì AED ${max}</div>`);
      }

      if (Array.isArray(p.must_haves) && p.must_haves.length)
        rows.push(`<div>‚ú® <b>Must-haves:</b> ${p.must_haves.join(", ")}</div>`);

      if (Array.isArray(p.lifestyle) && p.lifestyle.length)
        rows.push(`<div>üß≠ <b>Lifestyle:</b> ${p.lifestyle.join(", ")}</div>`);

      if (p.style)
        rows.push(`<div>üé® <b>Preferred style:</b> ${p.style}</div>`);

      if (p.commute)
        rows.push(`<div>üöâ <b>Commute / access:</b> ${p.commute}</div>`);

      if (p.budget_mindset)
        rows.push(`<div>üß† <b>Budget mindset:</b> ${p.budget_mindset}</div>`);

      if (p.notes)
        rows.push(`<div>üìù <b>Notes:</b> ${p.notes}</div>`);

      recPrefsEcho.innerHTML = rows.length
        ? rows.join("")
        : `<div class="text-gray-500">No saved preferences found yet.</div>`;
    }

    const truthy = v => v===true || v==='true' || v===1 || v==='1';

    function normalizeBedrooms(val){
      if (val==null) return null;
      const s = String(val).toLowerCase().trim();
      if (s.includes("studio")) return 0;
      const n = parseInt(s, 10);
      return Number.isFinite(n) ? n : null;
    }

    function buildAmenities(prefs){
      const set = new Set();
      if (Array.isArray(prefs.must_haves)) prefs.must_haves.forEach(x=>set.add(x));
      if (typeof prefs.amenities === "string")
        prefs.amenities
          .split(",")
          .map(s=>s.trim())
          .filter(Boolean)
          .forEach(x=>set.add(x));
      return Array.from(set).join(",");
    }

    /******** Recommendations ********/
    const recList  = document.getElementById("recList");
    const recError = document.getElementById("recError");
    const recBadge = document.getElementById("recBadge");

    async function callRecommender(payload){
      const r = await fetch('/api/recommend', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }

    function recItemHTML(row, score){
      const title = row.title || `${row.bedrooms?`${row.bedrooms}BR `:''}${row.property_type||'Property'}`;
      const where = [row.building,row.community,row.city].filter(Boolean).join(', ');
      const scoreTxt = (score!=null && !isNaN(score))
        ? `<span class="text-xs text-gray-500">Score: ${(+score).toFixed(3)}</span>`
        : "";
      return `
        <div class="py-3 flex items-start justify-between gap-3">
          <div>
            <a href="listing.html" class="text-indigo-600 font-semibold hover:underline" data-rec-id="${row.listing_id}">${title}</a>
            <div class="text-gray-600 text-sm">${where}</div>
            <div class="text-gray-900 font-semibold">${fmtAED(row.price)}</div>
            ${scoreTxt}
          </div>
          <button data-rec-id="${row.listing_id}" class="px-3 py-1 rounded-lg bg-indigo-600 text-white text-sm hover:bg-indigo-700">View</button>
        </div>`;
    }

    function wireRecLinks(rowsWithScore){
      recList.querySelectorAll("[data-rec-id]").forEach(el=>{
        el.addEventListener("click", async (e)=>{
          e.preventDefault();
          const id = el.getAttribute("data-rec-id");
          const row = rowsWithScore.find(r=>r.row.listing_id===id)?.row || await fetchListingById(id);
          if (row) openListing(row);
        });
      });
    }

    async function runRecommendationsFromSavedPrefs(){
      recError.classList.add("hidden");
      recList.innerHTML = `<div class="py-3 text-sm text-gray-500">Loading recommendations‚Ä¶</div>`;
      recBadge.textContent = "‚Äî";

      const uid = (auth.currentUser && auth.currentUser.uid) || null;
      const prefs = loadSavedPrefs(uid);
      echoPrefs(prefs);

      const community = (prefs.community || prefs.areas || "").toString().split(",")[0]?.trim() || "";
      const payload = {
        community,
        property_type: prefs.property_type || prefs.type || "Apartment",
        bedrooms: normalizeBedrooms(prefs.bedrooms) ?? 2,
        bathrooms: Number(prefs.bathrooms) || 2,
        min_price: Number(prefs.budget_min ?? prefs.min_price ?? 0) || 0,
        max_price: Number(prefs.budget_max ?? prefs.max_price ?? 999999999) || 999999999,
        metro_nearby: truthy(prefs.metro_nearby) || (prefs.commute === "metro_access"),
        mall_nearby:  truthy(prefs.mall_nearby)  || (Array.isArray(prefs.lifestyle) && prefs.lifestyle.includes("city_vibes")),
        amenities: buildAmenities(prefs)
      };

      try{
        const data = await callRecommender(payload);

        const raw = Array.isArray(data) ? data :
                    Array.isArray(data.results) ? data.results :
                    Array.isArray(data.ids) ? data.ids.map(id=>({listing_id:id})) : [];

        const norm = raw.map(x=>{
          const id = x.listing_id || x.id || x.listingId || x.listing || x;
          const score = typeof x === "object" ? (x.score ?? x.similarity ?? x.rank ?? null) : null;
          return { id, score };
        }).filter(x=>x.id);

        const rowsWithScore = [];
        for (const n of norm.slice(0,5)){
          const row = await fetchListingById(n.id);
          if (row) rowsWithScore.push({ row, score: n.score });
        }

        recList.innerHTML = rowsWithScore.length
          ? rowsWithScore.map(({row,score})=>recItemHTML(row,score)).join("")
          : `<div class="text-sm text-gray-600 py-3">No matches found for your saved preferences.</div>`;

        recBadge.textContent = rowsWithScore.length ? `${rowsWithScore.length} shown` : "0 shown";
        wireRecLinks(rowsWithScore);
      }catch(err){
        recError.textContent = `Recommendation failed: ${err.message || err}`;
        recError.classList.remove("hidden");
        recList.innerHTML = "";
      }
    }

    /******** Init ********/
    document.getElementById("applyBtn")?.addEventListener("click", refresh);
    refresh();
  </script>
</body>
</html>
